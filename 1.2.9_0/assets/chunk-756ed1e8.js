import{l as E,S as m,W as D,U as A}from"./chunk-47d31085.js";import{l as P,I as x}from"./chunk-9bf1c375.js";import{c as R,d as U,b as G,g as M,h as S,p as O,f as k,a as L,P as y,_ as f,i as F}from"./chunk-225708e2.js";import{s as l,a as I}from"./chunk-ad171556.js";var b=L(),d=new Map,v=new Map,T=new Map,N=(e,t)=>(v.set(e,(v.get(e)||new Set).add(t)),()=>{const n=v.get(e);n?.delete(t)&&n?.size===0&&v.delete(e)}),h=(e,t)=>{T.set(e,(T.get(e)||new Set).add(t))},g=e=>({withFingerprint:t=>{const n=i=>({and:()=>i}),a={aboutIncomingMessage:i=>{const r=d.get(e);return y.toExtensionContext(r.port,{status:"incoming",message:i}),n(a)},aboutSuccessfulDelivery:i=>{const r=d.get(e);return y.toExtensionContext(r.port,{status:"delivered",receipt:i}),n(a)},aboutMessageUndeliverability:(i,r)=>{const o=d.get(e);return o?.fingerprint===t&&y.toExtensionContext(o.port,{status:"undeliverable",resolvedDestination:i,message:r}),n(a)},whenDeliverableTo:i=>{const r=()=>{const o=d.get(e);if(o?.fingerprint===t&&d.has(i))return y.toExtensionContext(o.port,{status:"deliverable",deliverableTo:i}),!0};if(!r()){const o=N(i,r);h(t,o)}return n(a)},aboutSessionEnded:i=>{const r=d.get(e);return r?.fingerprint===t&&y.toExtensionContext(r.port,{status:"terminated",fingerprint:i}),n(a)}};return a}}),q=R(),_=U("background",e=>{var t;if(e.origin.context==="background"&&["content-script","devtools "].includes(e.destination.context)&&!e.destination.tabId)throw new TypeError("When sending messages from background page, use @tabId syntax to target specific tab");const n=S(f(f({},e.origin),e.origin.context==="window"&&{context:"content-script"})),a=S(F(f(f({},e.destination),e.destination.context==="window"&&{context:"content-script"}),{tabId:e.destination.tabId||e.origin.tabId}));e.destination.tabId=null,e.destination.frameId=null;const i=()=>d.get(a),r=()=>d.get(n),o=()=>{var p;g(a).withFingerprint(i().fingerprint).aboutIncomingMessage(e);const w={message:e,to:i().fingerprint,from:{endpointId:n,fingerprint:(p=r())==null?void 0:p.fingerprint}};e.messageType==="message"&&b.add(w),e.messageType==="reply"&&b.remove(e.messageID),r()&&g(n).withFingerprint(r().fingerprint).aboutSuccessfulDelivery(w)};(t=i())!=null&&t.port?o():e.messageType==="message"&&(e.origin.context==="background"?N(a,o):r()&&g(n).withFingerprint(r().fingerprint).aboutMessageUndeliverability(a,e).and().whenDeliverableTo(a))},e=>{const t=S(f(f({},e.origin),e.origin.context==="window"&&{context:"content-script"})),n=d.get(t),a={message:e,to:q,from:{endpointId:t,fingerprint:n.fingerprint}};g(t).withFingerprint(n.fingerprint).aboutSuccessfulDelivery(a)});G.runtime.onConnect.addListener(e=>{var t;const n=M(e.name);if(!n)return;n.endpointName||(n.endpointName=S({context:"content-script",tabId:e.sender.tab.id,frameId:e.sender.frameId}));const{tabId:a,frameId:i}=O(n.endpointName);d.set(n.endpointName,{fingerprint:n.fingerprint,port:e}),(t=v.get(n.endpointName))==null||t.forEach(r=>r()),v.delete(n.endpointName),h(n.fingerprint,()=>{const r=b.entries().filter(o=>o.to===n.fingerprint);b.remove(r),r.forEach(o=>{o.from.endpointId==="background"?_.endTransaction(o.message.transactionId):g(o.from.endpointId).withFingerprint(o.from.fingerprint).aboutSessionEnded(n.fingerprint)})}),e.onDisconnect.addListener(()=>{var r,o;((r=d.get(n.endpointName))==null?void 0:r.fingerprint)===n.fingerprint&&d.delete(n.endpointName),(o=T.get(n.fingerprint))==null||o.forEach(p=>p()),T.delete(n.fingerprint)}),e.onMessage.addListener(r=>{var o,p;if(r.type==="sync"){const w=[...d.values()].map(u=>u.fingerprint),C=r.pendingResponses.filter(u=>w.includes(u.to));b.add(...C),r.pendingResponses.filter(u=>!w.includes(u.to)).forEach(u=>g(n.endpointName).withFingerprint(n.fingerprint).aboutSessionEnded(u.to)),r.pendingDeliveries.forEach(u=>g(n.endpointName).withFingerprint(n.fingerprint).whenDeliverableTo(u));return}r.type==="deliver"&&((p=(o=r.message)==null?void 0:o.origin)==null?void 0:p.context)&&(r.message.origin.tabId=a,r.message.origin.frameId=i,_.handleMessage(r.message))})});var{sendMessage:c,onMessage:s}=_;k(_);s("get-queued-count",async()=>{try{return await l.getTotals([],"","queued")}catch{return}});s("get-done-count",async()=>{try{return await l.getTotals([],"","done")}catch{return}});s("get-error-count",async()=>{try{return await l.getTotals([],"","error")}catch{return}});s("get-first-queued-record",async()=>{try{return await l.getFirstQueuedRecord()}catch{return}});s("mark-done-removals-url",async({data:e})=>{try{const{url:t}=e;await l.markDone(t)}catch(t){console.log(t)}});s("mark-error-removals-url",async({data:e})=>{try{const{url:t}=e;await l.markError(t,e?.error||"Unknown error")}catch(t){console.log(t)}});s("bing-get-queued-count",async()=>{try{return await I.getTotals([],"","queued")}catch{return}});s("bing-get-done-count",async()=>{try{return await I.getTotals([],"","done")}catch{return}});s("bing-get-error-count",async()=>{try{return await I.getTotals([],"","error")}catch{return}});s("bing-get-first-queued-record",async()=>{try{return await I.getFirstQueuedRecord()}catch{return}});s("bing-mark-done-removals-url",async({data:e})=>{try{const{url:t}=e;await I.markDone(t)}catch(t){console.log(t)}});s("START_SYNC",async({data:e})=>{const t=e;console.log("START_SYNC",t),await E.set(m,"LOADING");const n=await l.getFirstQueuedRecord();t.urlData=n,console.log("START_SYNC",t),await c("CLICK_BUTTON_NEW_REQUEST",t,"content-script@0")});s("MARK_DONE",async({data:e})=>{try{const t=e,{urlData:n,delay:a}=t;await l.markDone(n.url),await E.set(m,"LOADING"),await c("MESSAGE_POPUP",{type:"success",message:"Mark done",status:"LOADING"},"popup"),await new Promise(i=>setTimeout(i,500)),await E.set(m,"STOP");for(let i=1;i<=a;i++){let r=await E.get(m);if(r!=="STOP")break;await c("MESSAGE_POPUP",{type:"warning",message:`Wait ${a-i}s`,status:r},"popup"),await new Promise(o=>setTimeout(o,1e3))}await c("LOOP_AGAIN",t,"popup")}catch(t){await E.set(m,"START"),await c("MESSAGE_POPUP",{type:"error",message:t.message,status:"START"},"popup")}});s("START_INDEXING",async({data:e})=>{try{const t=e;await c("MESSAGE_POPUP_INDEXING",{type:"warning",message:"Wait and do not close this tab",loading:!0},"popup"),await c("CLICK_BUTTON_INDEXING",t,"content-script")}catch(t){await c("MESSAGE_POPUP_INDEXING",{type:"error",message:t.message},"popup")}});s("MARK_DONE_INDEXING",async({data:e})=>{try{await c("MESSAGE_POPUP_INDEXING",{type:"success",message:"Done indexing",loading:!1},"popup")}catch(t){await c("MESSAGE_POPUP_INDEXING",{type:"error",message:t.message,loading:!1},"popup")}});(function(e){e.runtime.onInstalled.addListener(t=>{t.reason=="install"&&(P.trackEvent(x),e.tabs.create({url:D}))}),e.runtime.setUninstallURL(A)})(chrome);
